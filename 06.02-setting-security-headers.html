<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="x-ua-compatible" content="ie=edge">
		<meta name="author" content="Alex Edwards">
		<meta name="copyright" content="Copyright Alex Edwards 2023">
		<title>Setting security headers &mdash; Let's Go</title>
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<link rel="stylesheet" type="text/css" href="assets/css/main.css">
	</head>
	<body>
		<header>
			<div class="wrapper">
				<div>
					
						
						<a href="00.00-front-matter.html">Let's Go</a> <span class="crumbs">&rsaquo; <a href="06.00-middleware.html">Middleware</a> &rsaquo; Setting security headers</span>
						
					
				</div>
				<div>
					&lsaquo; <a href="06.01-how-middleware-works.html">Previous</a>
					&middot; <a href="00.01-contents.html">Contents</a> &middot;
					<a href="06.03-request-logging.html">Next</a> &rsaquo;
				</div>
			</div>
		</header>
		<main class="wrapper text">
			<div class="chapter">Chapter 6.2.</div>
			<h2 id="setting-security-headers">Setting security headers</h2>

<p>Let&rsquo;s put the pattern we learned in the previous chapter to use, and make our own middleware which automatically adds the following HTTP security headers to every response, inline with <a href="https://owasp.org/www-project-secure-headers">current OWASP guidance</a>.
<br><br>
ì´ì „ ì¥ì—ì„œ ë°°ìš´ íŒ¨í„´ì„ í™œìš©í•˜ì—¬ ìš°ë¦¬ë§Œì˜ ë¯¸ë“¤ì›¨ì–´ë¥¼ ë§Œë“¤ì–´ ë³´ê² ìŠµë‹ˆë‹¤. ì´ ë¯¸ë“¤ì›¨ì–´ëŠ” <a href="https://owasp.org/www-project-secure-headers">í˜„ì¬ OWASP ê°€ì´ë“œë¼ì¸</a>ì— ë”°ë¼ ëª¨ë“  ì‘ë‹µì— ìë™ìœ¼ë¡œ ë‹¤ìŒ HTTP ë³´ì•ˆ í—¤ë”ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
</p>

<figure class="code plain">
<pre>Content-Security-Policy: default-src &#39;self&#39;; style-src &#39;self&#39; fonts.googleapis.com; font-src fonts.gstatic.com
Referrer-Policy: origin-when-cross-origin
X-Content-Type-Options: nosniff
X-Frame-Options: deny
X-XSS-Protection: 0</pre>
</figure>

<p>If youâ€™re not familiar with these headers, I&rsquo;ll quickly explain what they do.
<br><br>
ì´ í—¤ë”ë“¤ì´ ìµìˆ™í•˜ì§€ ì•Šë‹¤ë©´, ê°„ë‹¨íˆ ì´ë“¤ì´ í•˜ëŠ” ì¼ì„ ì„¤ëª…í•˜ê² ìŠµë‹ˆë‹¤.
</p>

<ul>
<li><p><code>Content-Security-Policy</code> (often abbreviated to <em>CSP</em>) headers are used to restrict where the resources for your web page (e.g. JavaScript, images, fonts etc) can be loaded from. Setting a strict CSP policy helps prevent a variety of cross-site scripting, clickjacking, and other code-injection attacks.
<br><br>
<code>Content-Security-Policy</code> í—¤ë”(ì¼ë°˜ì ìœ¼ë¡œ <em>CSP</em>ë¡œ ì¤„ì—¬ì§)ëŠ” ì›¹ í˜ì´ì§€ì˜ ë¦¬ì†ŒìŠ¤ (e.g. JavaScript, images, fonts etc)ê°€ ë¡œë“œë  ìˆ˜ ìˆëŠ” ìœ„ì¹˜ë¥¼ ì œí•œí•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ì—„ê²©í•œ CSP ì •ì±…ì„ ì„¤ì •í•˜ë©´ ë‹¤ì–‘í•œ cross-site scripting, clickjacking ë° ê¸°íƒ€ code-injection ê³µê²©ì„ ë°©ì§€í•˜ëŠ” ë° ë„ì›€ì´ ë©ë‹ˆë‹¤.
</p>

<p>CSP headers and how they work is a big topic, and I recommend reading <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP">this primer</a> if you haven&rsquo;t come across them before. But, in our case, the header tells the browser that it&rsquo;s OK to load fonts from <code>fonts.gstatic.com</code>, stylesheets from <code>fonts.googleapis.com</code> and <code>self</code> (our own origin), and then <em>everything else</em> only from <code>self</code>. Inline JavaScript is blocked by default.
<br><br>
CSP í—¤ë” ë° ì‘ë™ ë°©ì‹ì€ í° ì£¼ì œì´ë©°, ì´ì „ì— ì ‘í•œ ì ì´ ì—†ë‹¤ë©´ <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP">ì´ ê¸°ì´ˆ ê°€ì´ë“œ</a>ë¥¼ ì½ëŠ” ê²ƒì„ ì¶”ì²œí•©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ìš°ë¦¬ì˜ ê²½ìš°ì—ëŠ” í—¤ë”ê°€ ë¸Œë¼ìš°ì €ì—ê²Œ <code>fonts.gstatic.com</code>ì—ì„œ í°íŠ¸ë¥¼ ë¡œë“œí•˜ëŠ” ê²ƒ, <code>fonts.googleapis.com</code> ë° <code>self</code>(ìì²´ ì¶œì²˜)ì—ì„œ ìŠ¤íƒ€ì¼ì‹œíŠ¸ë¥¼ ë¡œë“œí•˜ëŠ” ê²ƒì´ í—ˆìš©ë˜ë©°, ê·¸ ì™¸ì˜ ëª¨ë“  ê²ƒì€ <code>self</code>ì—ì„œë§Œ ë¡œë“œí•  ìˆ˜ ìˆìŒì„ ì•Œë ¤ì¤ë‹ˆë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ Inline JavaScriptëŠ” ì°¨ë‹¨ë©ë‹ˆë‹¤.
</p></li>

<li><p><code>Referrer-Policy</code> is used to control what information is included in a <code>Referer</code> header when a user navigates away from your web page. In our case, we&rsquo;ll set the value to <code>origin-when-cross-origin</code>, which means that the full URL will be included for <a href="https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy">same-origin requests</a>, but for all other requests information like the URL path and any query string values will be stripped out.
<br><br>
<code>Referrer-Policy</code>ëŠ” ì‚¬ìš©ìê°€ ì›¹ í˜ì´ì§€ë¥¼ ë²—ì–´ë‚  ë•Œ <code>Referer</code> í—¤ë”ì— í¬í•¨ë˜ëŠ” ì •ë³´ë¥¼ ì œì–´í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ìš°ë¦¬ì˜ ê²½ìš°ì—ëŠ” ê°’ì„ <code>origin-when-cross-origin</code> ìœ¼ë¡œ ì„¤ì •í•  ê²ƒì´ë©°, ì´ëŠ” <a href="https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy">ë™ì¼ ì¶œì²˜ ìš”ì²­</a>ì— ëŒ€í•´ ì „ì²´ URLì´ í¬í•¨ë˜ì§€ë§Œ ë‹¤ë¥¸ ëª¨ë“  ìš”ì²­ì— ëŒ€í•´ì„œëŠ” URL ê²½ë¡œ ë° ì¿¼ë¦¬ ë¬¸ìì—´ ê°’ê³¼ ê°™ì€ ì •ë³´ê°€ ì œê±°ë  ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.

</p></li>

<li><p><code>X-Content-Type-Options: nosniff</code> instructs browsers to <em>not</em> MIME-type sniff the content-type of the response, which in turn helps to prevent <a href="https://security.stackexchange.com/questions/7506/using-file-extension-and-mime-type-as-output-by-file-i-b-combination-to-dete/7531#7531">content-sniffing attacks</a>.
<br><br>
<code>X-Content-Type-Options: nosniff</code> ì€ ë¸Œë¼ìš°ì €ì—ê²Œ ì‘ë‹µì˜ ì½˜í…ì¸  ìœ í˜•ì„ MIME-typeìœ¼ë¡œ ìŠ¤ë‹ˆí•‘í•˜ì§€ ë§ë„ë¡ ì§€ì‹œí•˜ë©°, ì´ëŠ” ê²°ê³¼ì ìœ¼ë¡œ <code>content-sniffing attacks</code> ì„ ë°©ì§€í•˜ëŠ” ë° ë„ì›€ì´ ë©ë‹ˆë‹¤.
</p></li>

<li><p><code>X-Frame-Options: deny</code> is used to help prevent <a href="https://developer.mozilla.org/en-US/docs/Web/Security/Types_of_attacks#click-jacking">clickjacking</a> attacks in older browsers that don&rsquo;t support CSP headers.
<br><br>
<code>X-Frame-Options: deny</code> ëŠ” CSP í—¤ë”ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ì´ì „ ë¸Œë¼ìš°ì €ì—ì„œ clickjacking ê³µê²©ì„ ë°©ì§€í•˜ëŠ” ë° ë„ì›€ì´ ë©ë‹ˆë‹¤.
</p></li>

<li><p><code>X-XSS-Protection: 0</code> is used to <em>disable</em> the blocking of cross-site scripting attacks. Previously it was good practice to set this header to <code>X-XSS-Protection: 1; mode=block</code>, but when you&rsquo;re using CSP headers like we are <a href="https://owasp.org/www-project-secure-headers/#x-xss-protection">the recommendation</a> is to disable this feature altogether.
<br><br>
<code>X-XSS-Protection: 0</code> ì€ í¬ë¡œìŠ¤ì‚¬ì´íŠ¸ ìŠ¤í¬ë¦½íŒ… ê³µê²© ì°¨ë‹¨ì„ ë¹„í™œì„±í™”í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. ì´ì „ì—ëŠ” ì´ í—¤ë”ë¥¼ <code>X-XSS-Protection: 1; mode=block</code> ë¡œ ì„¤ì •í•˜ëŠ” ê²ƒì´ ì¢‹ì€ ë°©ë²•ì´ì—ˆì§€ë§Œ, ìš°ë¦¬ì²˜ëŸ¼ CSP í—¤ë”ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš° ì´ ê¸°ëŠ¥ì„ ì™„ì „íˆ ë¹„í™œì„±í™”í•˜ëŠ” ê²ƒì´ ê¶Œì¥ë©ë‹ˆë‹¤.

</p></li>
</ul>

<p>OK, let&rsquo;s get back to our Go code and begin by creating a new <code>middleware.go</code> file. We&rsquo;ll use this to hold all the custom middleware that we write throughout this book.
<br><br>
ì¢‹ì•„ìš”, ì´ì œ Go ì½”ë“œë¡œ ëŒì•„ê°€ì„œ ìƒˆë¡œìš´ <code>middleware.go</code> íŒŒì¼ì„ ë§Œë“¤ì–´ ë³´ê² ìŠµë‹ˆë‹¤. ì´ íŒŒì¼ì€ ì´ ì±… ì „ì²´ì—ì„œ ì‘ì„±í•˜ëŠ” ëª¨ë“  ì‚¬ìš©ì ì§€ì • ë¯¸ë“¤ì›¨ì–´ë¥¼ ë³´ê´€í•˜ëŠ” ë° ì‚¬ìš©í•  ê²ƒì…ë‹ˆë‹¤.
</p>

<figure class="code bash">
<pre>$ touch cmd/web/middleware.go</pre>
</figure>

<p>Then open it up and add a <code>secureHeaders()</code> function using the pattern that we introduced in the previous chapter:
<br><br>
ê·¸ëŸ° ë‹¤ìŒ íŒŒì¼ì„ ì—´ê³  ì´ì „ ì¥ì—ì„œ ì†Œê°œí•œ íŒ¨í„´ì„ ì‚¬ìš©í•˜ì—¬ <code>secureHeaders()</code> í•¨ìˆ˜ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”:
</p>

<figure class="code go">
<figcaption>File: cmd/web/middleware.go</figcaption>
<pre><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;net/http&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">secureHeaders</span><span class="p">(</span><span class="nx">next</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">http</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Note: This is split across multiple lines for readability. You don&#39;t 
</span><span class="c1"></span>        <span class="c1">// need to do this in your own code.
</span><span class="c1"></span>        <span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Content-Security-Policy&#34;</span><span class="p">,</span>
            <span class="s">&#34;default-src &#39;self&#39;; style-src &#39;self&#39; fonts.googleapis.com; font-src fonts.gstatic.com&#34;</span><span class="p">)</span>

        <span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Referrer-Policy&#34;</span><span class="p">,</span> <span class="s">&#34;origin-when-cross-origin&#34;</span><span class="p">)</span>
        <span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;X-Content-Type-Options&#34;</span><span class="p">,</span> <span class="s">&#34;nosniff&#34;</span><span class="p">)</span>
        <span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;X-Frame-Options&#34;</span><span class="p">,</span> <span class="s">&#34;deny&#34;</span><span class="p">)</span>
        <span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;X-XSS-Protection&#34;</span><span class="p">,</span> <span class="s">&#34;0&#34;</span><span class="p">)</span>

        <span class="nx">next</span><span class="p">.</span><span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
    <span class="p">}</span><span class="p">)</span>
<span class="p">}</span></pre>
</figure>

<p>Because we want this middleware to act on every request that is received, we need it to be executed <em>before</em> a request hits our servemux. We want the flow of control through our application to look like:
<br><br>
ì´ ë¯¸ë“¤ì›¨ì–´ë¥¼ ìˆ˜ì‹ ëœ ëª¨ë“  ìš”ì²­ì— ì ìš©í•˜ë ¤ë©´ í•´ë‹¹ ë¯¸ë“¤ì›¨ì–´ê°€ servemuxì— ë„ë‹¬í•˜ê¸° ì „ì— ì‹¤í–‰ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ìš°ë¦¬ëŠ” ì‘ìš© í”„ë¡œê·¸ë¨ì„ í†µí•œ ì œì–´ íë¦„ì´ ë‹¤ìŒê³¼ ê°™ì•„ ë³´ì´ê¸¸ ì›í•©ë‹ˆë‹¤:
</p>

<figure class="code plain">
<pre><mark>secureHeaders</mark> â†’ servemux â†’ application handler</pre>
</figure>

<p>To do this we&rsquo;ll need the <code>secureHeaders</code> middleware function to <em>wrap our servemux</em>. Letâ€™s update the <code>routes.go</code> file to do exactly that:
<br><br>
ì´ë¥¼ ìœ„í•´ <code>secureHeaders</code> ë¯¸ë“¤ì›¨ì–´ í•¨ìˆ˜ê°€ servemuxë¥¼ ë˜í•‘í•˜ë„ë¡ í•´ì•¼ í•©ë‹ˆë‹¤. ì´ë¥¼ ìœ„í•´ <code>routes.go</code> íŒŒì¼ì„ ì—…ë°ì´íŠ¸í•´ ë³´ê² ìŠµë‹ˆë‹¤:
</p>

<figure class="code go">
<figcaption>File: cmd/web/routes.go</figcaption>
<pre><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">&#34;net/http&#34;</span>

<span class="c1">// Update the signature for the routes() method so that it returns a
</span><span class="c1"></span><span class="c1">// http.Handler instead of *http.ServeMux.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">app</span> <span class="o">*</span><span class="nx">application</span><span class="p">)</span> <span class="nf">routes</span><span class="p">(</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span>
    <span class="nx">mux</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">NewServeMux</span><span class="p">(</span><span class="p">)</span>

    <span class="nx">fileServer</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">FileServer</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nf">Dir</span><span class="p">(</span><span class="s">&#34;./ui/static/&#34;</span><span class="p">)</span><span class="p">)</span>
    <span class="nx">mux</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;/static/&#34;</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nf">StripPrefix</span><span class="p">(</span><span class="s">&#34;/static&#34;</span><span class="p">,</span> <span class="nx">fileServer</span><span class="p">)</span><span class="p">)</span>

    <span class="nx">mux</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="nx">app</span><span class="p">.</span><span class="nx">home</span><span class="p">)</span>
    <span class="nx">mux</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/snippet/view&#34;</span><span class="p">,</span> <span class="nx">app</span><span class="p">.</span><span class="nx">snippetView</span><span class="p">)</span>
    <span class="nx">mux</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/snippet/create&#34;</span><span class="p">,</span> <span class="nx">app</span><span class="p">.</span><span class="nx">snippetCreate</span><span class="p">)</span>

    <span class="c1">// Pass the servemux as the &#39;next&#39; parameter to the secureHeaders middleware.
</span><span class="c1"></span>    <span class="c1">// Because secureHeaders is just a function, and the function returns a
</span><span class="c1"></span>    <span class="c1">// http.Handler we don&#39;t need to do anything else.
</span><span class="c1"></span>    <span class="k">return</span> <span class="nf">secureHeaders</span><span class="p">(</span><span class="nx">mux</span><span class="p">)</span>
<span class="p">}</span></pre>
</figure>

<aside class="important"><p>
<strong>Important:</strong> Make sure that you update the signature of the <code>routes()</code> method so that it returns a <code>http.Handler</code> here, otherwise you&rsquo;ll get a compile-time error.
<br><br>
<strong>Important:</strong> ì—¬ê¸°ì—ì„œ <code>routes()</code> ë©”ì„œë“œì˜ ì‹œê·¸ë‹ˆì²˜ë¥¼ <code>http.Handler</code> ë¥¼ ë°˜í™˜í•˜ë„ë¡ ì—…ë°ì´íŠ¸í•˜ëŠ” ê²ƒì„ ìŠì§€ ë§ˆì„¸ìš”. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì»´íŒŒì¼ ì‹œê°„ ì˜¤ë¥˜ê°€ ë°œìƒí•©ë‹ˆë‹¤.
</p></aside>

<p>Go ahead and give this a try. Run the application then open a terminal window and try making some requests with curl. You should see that the security headers are now included in every response.
<br><br>
ê³„ì† ì§„í–‰í•´ë³´ì„¸ìš”. ì‘ìš© í”„ë¡œê·¸ë¨ì„ ì‹¤í–‰í•œ ë‹¤ìŒ í„°ë¯¸ë„ ì°½ì„ ì—´ê³  curlë¡œ ëª‡ ê°€ì§€ ìš”ì²­ì„ ì‹œë„í•´ë³´ì„¸ìš”. ëª¨ë“  ì‘ë‹µì— ë³´ì•ˆ í—¤ë”ê°€ í¬í•¨ë˜ì–´ ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
</p>

<figure class="code bash">
<pre>$ curl -I http://localhost:4000/
<samp>HTTP/1.1 200 OK
Content-Security-Policy: default-src &#39;self&#39;; style-src &#39;self&#39; fonts.googleapis.com; font-src fonts.gstatic.com
Referrer-Policy: origin-when-cross-origin
X-Content-Type-Options: nosniff
X-Frame-Options: deny
X-Xss-Protection: 0
Date: Wed, 06 Sep 2023 14:16:39 GMT
Content-Length: 1700
Content-Type: text/html; charset=utf-8</samp></pre>
</figure>

<hr />

<h3 id="additional-information">Additional information</h3>

<h4 id="flow-of-control">Flow of control</h4>

<p>It&rsquo;s important to know that when the last handler in the chain returns, control is passed back up the chain in the reverse direction. So when our code is being executed the flow of control actually looks like this:
<br><br>
ì¤‘ìš”í•œ ê²ƒì€ ì²´ì¸ì˜ ë§ˆì§€ë§‰ í•¸ë“¤ëŸ¬ê°€ ë°˜í™˜ë˜ë©´ ì œì–´ê°€ ë°˜ëŒ€ ë°©í–¥ìœ¼ë¡œ ë‹¤ì‹œ ì²´ì¸ì„ ë”°ë¼ ì „ë‹¬ëœë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. ë”°ë¼ì„œ ìš°ë¦¬ì˜ ì½”ë“œê°€ ì‹¤í–‰ë  ë•Œ ì œì–´ íë¦„ì€ ì‹¤ì œë¡œ ë‹¤ìŒê³¼ ê°™ì´ ë³´ì…ë‹ˆë‹¤:
</p>

<figure class="code plain">
<pre><mark>secureHeaders(ìš”ì²­ ì²´ì¸ìƒì—ì„œ)</mark> â†’ servemux â†’ application handler â†’ servemux â†’ <mark>secureHeaders(ì‘ë‹µ ì²´ì¸ìƒì—ì„œ)</mark></pre>
</figure>

<p>In any middleware handler, code which comes before <code>next.ServeHTTP()</code> will be executed on the way down the chain, and any code after <code>next.ServeHTTP()</code>  &mdash; or in a deferred function &mdash; will be executed on the way back up.
<br><br>
<u>ì–´ë–¤ ë¯¸ë“¤ì›¨ì–´ í•¸ë“¤ëŸ¬ì—ì„œë“  <code>next.ServeHTTP()</code> ì´ì „ì— ì˜¤ëŠ” ì½”ë“œëŠ” ì²´ì¸ì„ ë”°ë¼ ë‚´ë ¤ê°ˆ ë•Œ ì‹¤í–‰ë˜ê³ , <code>next.ServeHTTP()</code> ì´í›„ì˜ ì½”ë“œë‚˜ ì§€ì—°ëœ í•¨ìˆ˜ì—ì„œëŠ” ì²´ì¸ì„ ë”°ë¼ ë‹¤ì‹œ ì˜¬ë¼ê°ˆ ë•Œ ì‹¤í–‰ë©ë‹ˆë‹¤.</u>
</p>

<figure class="code go">
<pre><span class="kd">func</span> <span class="nf">myMiddleware</span><span class="p">(</span><span class="nx">next</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">http</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Any code here will execute on the way down the chain.
</span><span class="c1"></span>        <span class="nx">next</span><span class="p">.</span><span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
        <span class="c1">// Any code here will execute on the way back up the chain.
</span><span class="c1"></span>    <span class="p">}</span><span class="p">)</span>
<span class="p">}</span></pre>
</figure>

<h4 id="early-returns">Early returns</h4>

<p>Another thing to mention is that if you call <code>return</code> in your middleware function <em>before</em> you call <code>next.ServeHTTP()</code>, then the chain will stop being executed and control will flow back upstream.
<br><br>
ì–¸ê¸‰í•  ì‚¬í•­ ì¤‘ í•˜ë‚˜ëŠ” middleware í•¨ìˆ˜ì—ì„œ <code>next.ServeHTTP()</code> ë¥¼ í˜¸ì¶œí•˜ê¸° ì „ì— <code>return</code> ì„ í˜¸ì¶œí•˜ë©´ ì²´ì¸ì´ ë” ì´ìƒ ì‹¤í–‰ë˜ì§€ ì•Šê³  ì œì–´ê°€ ìƒë¥˜ë¡œ íë¥´ê²Œ ëœë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.
</p>

<p>As an example, a common use-case for early returns is authentication middleware which only allows execution of the chain to continue if a particular check is passed. For instance:
<br><br>
ì˜ˆë¥¼ ë“¤ì–´ íŠ¹ì • í™•ì¸ì´ í†µê³¼ë˜ì§€ ì•Šìœ¼ë©´ ì²´ì¸ì˜ ì‹¤í–‰ì„ ê³„ì† í—ˆìš©í•˜ì§€ ì•ŠëŠ” ì¸ì¦ ë¯¸ë“¤ì›¨ì–´ì˜ ê²½ìš°, ì¡°ê¸° ë°˜í™˜ì€ ì¼ë°˜ì ì¸ ì‚¬ìš© ì‚¬ë¡€ì…ë‹ˆë‹¤. ë‹¤ìŒê³¼ ê°™ì´:
</p>

<figure class="code go">
<pre><span class="kd">func</span> <span class="nf">myMiddleware</span><span class="p">(</span><span class="nx">next</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">http</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// If the user isn&#39;t authorized, send a 403 Forbidden status and
</span><span class="c1"></span>        <span class="c1">// return to stop executing the chain.
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">!</span><span class="nf">isAuthorized</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">w</span><span class="p">.</span><span class="nf">WriteHeader</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusForbidden</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="c1">// Otherwise, call the next handler in the chain.
</span><span class="c1"></span>        <span class="nx">next</span><span class="p">.</span><span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
    <span class="p">}</span><span class="p">)</span>
<span class="p">}</span></pre>
</figure>

<p>We&rsquo;ll use this &lsquo;early return&rsquo; pattern <a href="11.06-user-authorization.html">later in the book</a> to restrict access to certain parts of our application.
<br><br>
ì´ &lsquo;early return&rsquo; íŒ¨í„´ì€ ì´ ì±…ì—ì„œ ì‘ìš© í”„ë¡œê·¸ë¨ì˜ íŠ¹ì • ë¶€ë¶„ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ë¥¼ ì œí•œí•˜ëŠ” ë° ë‚˜ì¤‘ì— ì‚¬ìš©í•  ê²ƒì…ë‹ˆë‹¤.
</p>

<h4 id="debugging-csp-issues">Debugging CSP issues</h4>

<p>While CSP headers are great and you should definitely use them, it&rsquo;s worth saying that I&rsquo;ve spent many hours trying to debug problems, only to eventually realize that a critical resource or script is being blocked by my own CSP rules ğŸ¤¦.
<br><br>
CSP í—¤ë”ëŠ” í›Œë¥­í•˜ë©° ê¼­ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ë‚˜ëŠ” ìì£¼ ë¬¸ì œë¥¼ ë””ë²„ê¹…í•˜ëŠ” ë° ë§ì€ ì‹œê°„ì„ ì†Œë¹„í–ˆëŠ”ë°, ê²°êµ­ì—ëŠ” ë‚´ ìì²´ CSP ê·œì¹™ì— ì˜í•´ ì¤‘ìš”í•œ ë¦¬ì†ŒìŠ¤ë‚˜ ìŠ¤í¬ë¦½íŠ¸ê°€ ì°¨ë‹¨ë˜ê³  ìˆìŒì„ ê¹¨ë‹«ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ¤¦
</p>

<p>If you&rsquo;re working on a project which is using CSP headers, like this one, I recommend keeping your web browser developer tools handy and getting into the habit of checking the logs early on if you run into any unexpected problems. In Firefox, any blocked resources will be shown as an error in the console logs &mdash; similar to this:
<br><br>
ì´ì™€ ê°™ì´ CSP í—¤ë”ë¥¼ ì‚¬ìš©í•˜ëŠ” í”„ë¡œì íŠ¸ì—ì„œ ì‘ì—…í•˜ê³  ìˆë‹¤ë©´, ì›¹ ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬ë¥¼ í•­ìƒ ì¤€ë¹„í•˜ê³  ì˜ˆìƒì¹˜ ëª»í•œ ë¬¸ì œì— ë¶€ë”ªí ë•Œ ë¡œê·¸ë¥¼ í™•ì¸í•˜ëŠ” ìŠµê´€ì„ ë“¤ì´ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. Firefoxì—ì„œëŠ” ì°¨ë‹¨ëœ ë¦¬ì†ŒìŠ¤ê°€ ì½˜ì†” ë¡œê·¸ì—ì„œ ì˜¤ë¥˜ë¡œ í‘œì‹œë©ë‹ˆë‹¤. ë‹¤ìŒê³¼ ë¹„ìŠ·í•©ë‹ˆë‹¤:
</p>

<figure class="img">
<img src="assets/img/06.02-01.png" alt="06.02-01.png" />
</figure>

		</main>
		<footer>
			<div class="wrapper">
				<div>
					&lsaquo; <a href="06.01-how-middleware-works.html">Previous</a>
				</div>
				<div>
					<a href="00.01-contents.html">Contents</a>
				</div>
				<div>
					<a href="06.03-request-logging.html">Next</a> &rsaquo;
				</div>
			</div>
		</footer>
		<script>
			document.onkeydown = function(evt) {
				evt = evt || window.event;
				switch (evt.keyCode) {
					
					case 37:
						window.location.href = "06.01-how-middleware-works.html";
						break;
						
					
					case 39:
						window.location.href = "06.03-request-logging.html";
						break;
						
				}
			};
		</script>
	</body>
</html>

